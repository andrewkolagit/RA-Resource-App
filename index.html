<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RA Resource App</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</head>
<body>
    /*<div class="notification-container">
        <span class="notification-bell" id="notificationBell">
            ðŸ””
            <span class="notification-dot" id="notificationDot"></span> <!-- New Notification Dot -->
        </span>
        <div class="notification-dropdown" id="notificationDropdown">
            <h3>Notifications</h3>
            <ul id="notificationList">
                <li>No new notifications</li>
            </ul>
        </div>
    </div>*/

  <div class="hamburger-menu" id="hamburgerMenu">
    &#9776; FORMS
</div>
<div class="side-panel" id="sidePanel"><br><br><br><br>
    <a href="https://app.smartsheet.com/b/form/5fc1445f7a8a43668ae2112e7ded57ae" class="menu-item">Vacancy Checks Forms</a>
    <a href="https://app.smartsheet.com/b/form/259fd614f83e4c3eb7bb7c947018ae63" class="menu-item">Rent Ready Form</a>
    <a href="health.html" class="menu-item">H & S Inspection Forms</a>
    <a href="https://app.smartsheet.com/b/form/4c72e5d3ea0b47f5a06a715729b406ff" class="menu-item">Maintenance Requests</a>
    <a href="https://app.smartsheet.com/b/form/e4b3157415d045118c5f80d04b256a54" class="menu-item">RA Time Off Request</a>
    <a href="https://app.smartsheet.com/b/form/e7f6798063c14cf9a19502f425f4ea09" class="menu-item">Lockout Form</a>
    <a href="https://app.smartsheet.com/b/form/3be370ba12b14142ba819f8119e0ead8" class="menu-item">Duty Report</a>
    <a href="https://cm.maxient.com/reportingform.php?AUMontgomery&layout_id=4" class="menu-item" target="_blank">Incident Report</a>
</div>

<div class="feedback-container">
    <span class="feedback-icon" onclick="toggleFeedbackPopup()">ðŸ’¬</span>
</div>

<div class="feedback-popup" id="feedbackPopup">
    <h3>Feedback</h3><br>
    <form id="feedbackForm">
        <textarea name="feedback" placeholder="Your Feedback" rows="4" required></textarea>
        <button type="submit">Submit</button>
    </form>
</div>
    
<div class="spacer"></div>
<div class="spacer"></div>
<div class="spacer"></div>
    <div class="container">
        <h1>RA RESOURCE APP</h1>
        <div class="option-list">
            <a href="information.html" class="option color-1">
                <div class="option-content">
                    <h2>ESSENTIAL INFORMATION</h2>
                </div>
            </a>
            <a href="starrez.html" class="option color-6">
                <div class="option-content">
                    <h2>Starrez Lookup</h2>
                </div>
            </a>
            <a href="https://aumontgomery-my.sharepoint.com/:x:/g/personal/msmith59_aum_edu/ES5lWxo8CcxBsgu4NelB3JMBv0XhkhI0cjNtxWzj4rHt4Q?e=ZBx4b3" class="option color-1">
                <div class="option-content">
                    <h2>NO ACCESS LIST</h2>
                </div>
            </a>
            <a href="Fall 2024 Duty Calendar.pdf" class="option color-2" target="_blank">
                <div class="option-content">
                    <h2>DUTY SCHEDULE</h2>
                </div>
            </a>
        </div>
    </div>

    <div class="spacer"></div>
  
    <div class="container duty-day-container">
        <h1>Current On Duty...</h1>
        <div id="dutyDayContent">
            <!-- Duty Day information will be populated here -->
        </div>
    </div>

    <div class="spacer"></div>
  
    <div class="container emergency-container">
        <h1>Emergency Contacts</h1>
        <p>If there is an emergency, please contact the following:</p>
        <h3><a href="tel:+13343183170" style="color: #A8E600;">CY/WH Duty Phone: +13343183170</a></h3>
        <h3><a href="tel:+13343183171" style="color: #A8E600;">NC/P-40 Duty Phone: +13343183171</a></h3>
        <h3><a href="tel:+13342443424" style="color: #A8E600;">Campus Police: +13342443424</a></h3>
        <br>
        <h1>RLCs</h1>
        <h3><a href="tel:+13343203385" style="color: #A8E600;">Ram: +13343203385</a></h3>
        <h3><a href="tel:+1332355208" style="color: #A8E600;">Amberly: +1332355208</a></h3>
        <h3><a href="tel:+1332243791" style="color: #A8E600;">Lauryn: +1332243791</a></h3>
        <h3><a href="tel:+13343003269" style="color: #A8E600;">Taylor: +13343003269</a></h3>
    </div><br><br>

    <script>
const notificationBell = document.getElementById('notificationBell');
const notificationDropdown = document.getElementById('notificationDropdown');
const notificationList = document.getElementById('notificationList');
const notificationDot = document.getElementById('notificationDot'); // Get the notification dot element

// Create overlay element
const overlay = document.createElement('div'); // Create overlay element
overlay.className = 'overlay'; // Assign class for styling
document.body.appendChild(overlay); // Add overlay to the body

notificationBell.addEventListener('click', () => {
    if (notificationDropdown.classList.contains('show')) {
        // If dropdown is already shown, apply closing animation
        notificationDropdown.classList.add('closing');
        notificationDropdown.addEventListener('animationend', function hideAfterClose() {
            notificationDropdown.style.display = 'none'; // Hide dropdown after animation ends
            notificationDropdown.classList.remove('show', 'closing'); // Remove classes
            overlay.classList.remove('visible'); // Hide overlay
            document.body.classList.remove('no-scroll'); // Enable page scroll
            notificationDropdown.removeEventListener('animationend', hideAfterClose);
        });
    } else {
        // Show dropdown and load notifications
        notificationDropdown.style.display = 'block'; // Show dropdown
        notificationDropdown.classList.add('show'); // Apply show class
        loadNotifications(); // Load notifications when bell is clicked
        notificationDot.style.display = 'none'; // Hide dot when dropdown is opened
        overlay.classList.add('visible'); // Show overlay
        document.body.classList.add('no-scroll'); // Disable page scroll
    }
});

// Close dropdown when clicking outside
window.addEventListener('click', (event) => {
    if (!event.target.matches('.notification-bell')) {
        if (notificationDropdown.classList.contains('show')) {
            // Apply closing animation when closing from outside
            notificationDropdown.classList.add('closing');
            notificationDropdown.addEventListener('animationend', function hideAfterClose() {
                notificationDropdown.style.display = 'none'; // Hide dropdown after animation ends
                notificationDropdown.classList.remove('show', 'closing'); // Remove classes
                overlay.classList.remove('visible'); // Hide overlay
                document.body.classList.remove('no-scroll'); // Enable page scroll
                notificationDropdown.removeEventListener('animationend', hideAfterClose);
            });
        }
    }
});

// Overlay click event to close the dropdown
overlay.addEventListener('click', () => {
    if (notificationDropdown.classList.contains('show')) {
        notificationDropdown.classList.add('closing');
        notificationDropdown.addEventListener('animationend', function hideAfterClose() {
            notificationDropdown.style.display = 'none'; // Hide dropdown after animation ends
            notificationDropdown.classList.remove('show', 'closing'); // Remove classes
            overlay.classList.remove('visible'); // Hide overlay
            document.body.classList.remove('no-scroll'); // Enable page scroll
            notificationDropdown.removeEventListener('animationend', hideAfterClose);
        });
    }
});

async function fetchNotifications() {
    const tableName = 'notifications'; // Replace with your table name
    const url = `/.netlify/functions/fetchAirtable?tableName=${tableName}`;

    const response = await fetch(url);

    if (!response.ok) {
        console.error('Error fetching notifications data:', response.statusText);
        return [];
    }

    const data = await response.json();
    return data.records;
}
        
        function filterNotifications(records) {
            const currentTime = new Date();
            const notificationsToShow = records.filter(record => {
                const dateToPost = new Date(record.fields.date_to_post);
                const dateToRemove = new Date(record.fields.date_to_remove);
                return (currentTime >= dateToPost && currentTime < dateToRemove);
            });

            return notificationsToShow;
        }

        async function loadNotifications() {
            const records = await fetchNotifications();
            const notifications = filterNotifications(records);

            notificationList.innerHTML = ''; // Clear existing notifications

            if (notifications.length === 0) {
                notificationList.innerHTML = '<li>No new notifications</li>';
                notificationDot.style.display = 'none'; // Hide the dot if no notifications
            } else {
                notificationDot.style.display = 'block'; // Show the dot if there are notifications
                notifications.forEach(notification => {
                    const li = document.createElement('li');
                    li.innerHTML = `<p><strong>Subject:</strong> ${notification.fields.subject}<br> - ${notification.fields.message}</p>`; // Bold subject with break
                    notificationList.appendChild(li);
                });
            }
        }

        // Duty Day functionality
        async function fetchDutyDay() {
    const tableName = 'dutyday'; // Replace with your table name
    const url = `/.netlify/functions/fetchAirtable?tableName=${tableName}`;

    const response = await fetch(url);

    if (!response.ok) {
        console.error('Error fetching notifications data:', response.statusText);
        return [];
    }

    const data = await response.json();
    return data.records;
        }

        async function loadDutyDay() {
            const records = await fetchDutyDay();
            const currentTime = new Date();
            const dutyDayContent = document.getElementById('dutyDayContent');

            // Reset content
            dutyDayContent.innerHTML = '';

            // Check if there's a matching duty day for the current time
            let hasData = false;
            records.forEach(record => {
                const dateStart = new Date(record.fields.date_start);
                const dateEnd = new Date(record.fields.date_end);
                
                if (currentTime >= dateStart && currentTime < dateEnd) {
                    hasData = true;

                    const div = document.createElement('div');
                    div.innerHTML = `
                        <h3>
                        <p>Warhawk/Courtyards:<br> <a>${record.fields.warhawk_courtyards}</a></p><br>
                        <p>Commons/P-40:<br> <a>${record.fields.commons_p40}</a></p><br>
                        <p>RLC:<br> <a>${record.fields.rlc}</a></p></h3>
                    `;
                    dutyDayContent.appendChild(div);
                }
            });

            // If no data found, show default message
            if (!hasData) {
                const defaultDiv = document.createElement('div');
                defaultDiv.innerHTML = `<p>Will update at 5PM</p>`;
                dutyDayContent.appendChild(defaultDiv);
            }
        }

        // Load both notifications and duty day on page load
        window.onload = () => {
            loadNotifications();
            loadDutyDay();
            setInterval(loadNotifications, 100);
            setInterval(loadDutyDay, 100);
            };
      
const hamburgerMenu = document.querySelector('.hamburger-menu');
const sidePanel = document.querySelector('.side-panel');

hamburgerMenu.addEventListener('click', () => {
    const isOpen = sidePanel.classList.toggle('open'); // Toggle the side panel
    overlay.classList.toggle('visible', isOpen); // Show/hide overlay based on panel state
    document.body.classList.toggle('no-scroll', isOpen); // Disable/enable page scroll
});

overlay.addEventListener('click', () => {
    // Close side panel when overlay is clicked
    sidePanel.classList.remove('open');
    overlay.classList.remove('visible'); // Hide the overlay
    document.body.classList.remove('no-scroll'); // Enable page scroll
});

// Close the side panel if clicked outside (overlay handles this)
window.addEventListener('click', (event) => {
    if (!sidePanel.contains(event.target) && !hamburgerMenu.contains(event.target) && sidePanel.classList.contains('open')) {
        sidePanel.classList.remove('open');
        overlay.classList.remove('visible'); // Hide the overlay
        document.body.classList.remove('no-scroll'); // Enable page scroll
    }
});
      
function toggleFeedbackPopup() {
    const feedbackPopup = document.getElementById("feedbackPopup");
    const overlay = document.querySelector('.overlay'); // Get the overlay element

    if (feedbackPopup.classList.contains("opening")) {
        // If the form is open, apply the closing animation
        feedbackPopup.classList.remove("opening");
        feedbackPopup.classList.add("closing");

        // Wait for animation to complete before hiding
        feedbackPopup.addEventListener("animationend", function hideAfterClose() {
            feedbackPopup.style.display = "none";
            feedbackPopup.classList.remove("closing");
            overlay.classList.remove("visible"); // Hide overlay
            document.body.classList.remove("no-scroll"); // Enable page scroll
            feedbackPopup.removeEventListener("animationend", hideAfterClose);
        });
    } else {
        // If the form is closed, apply the opening animation
        feedbackPopup.classList.add("opening");
        feedbackPopup.style.display = "block";
        overlay.classList.add("visible"); // Show overlay
        document.body.classList.add("no-scroll"); // Disable page scroll
    }
}

// Close the popup when clicking outside of it
document.addEventListener("click", function(event) {
    const feedbackPopup = document.getElementById("feedbackPopup");
    const feedbackIcon = document.querySelector(".feedback-icon");
    const overlay = document.querySelector('.overlay'); // Get the overlay element

    // Check if the clicked target is not the popup or the feedback icon
    if (!feedbackPopup.contains(event.target) && !feedbackIcon.contains(event.target)) {
        // Close the popup if it is open
        if (feedbackPopup.classList.contains("opening")) {
            toggleFeedbackPopup();
        }
    }
});

// Overlay click event to close the feedback popup
overlay.addEventListener('click', () => {
    if (feedbackPopup.classList.contains("opening")) {
        toggleFeedbackPopup(); // Close the popup on overlay click
    }
});

// Function to send data to Airtable
async function sendFeedbackToAirtable(feedbackData) {
    const response = await fetch('/.netlify/functions/submitFeedback', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ feedback: feedbackData }) // Sending feedback as JSON
    });

    if (!response.ok) {
        const error = await response.json();
        console.error('Error:', error);
        alert('Error submitting feedback. Please try again later.');
    } else {
        alert('Feedback submitted successfully!');

        // Clear the form fields
        document.getElementById('feedbackForm').reset(); // Resets all form fields

        // Optionally, close the feedback popup after submission
        toggleFeedbackPopup();
    }
}

</script>
</body>
</html>
