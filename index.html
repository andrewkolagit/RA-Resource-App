<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RA Help App</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</head>
<body>
    <div class="notification-container">
        <span class="notification-bell" id="notificationBell">
            ðŸ””
            <span class="notification-dot" id="notificationDot"></span>
        </span>
        <div class="notification-dropdown" id="notificationDropdown">
            <h3>Notifications</h3>
            <ul id="notificationList">
                <li>No new notifications</li>
            </ul>
        </div>
    </div>

    <div class="container">
        <h1>RA HELP APP</h1>
        <div class="option-list">
            <a href="information.html" class="option color-1">
                <div class="option-content">
                    <h2>ESSENTIAL INFORMATION</h2>
                </div>
            </a>
            <a href="forms.html" class="option color-2">
                <div class="option-content">
                    <h2>FORMS</h2>
                </div>
            </a>
            <a href="https://app.smartsheet.com/b/form/e7f6798063c14cf9a19502f425f4ea09" class="option color-4">
                <div class="option-content">
                    <h2>LOCKOUT FORM</h2>
                </div>
            </a>
            <a href="https://app.smartsheet.com/b/form/3be370ba12b14142ba819f8119e0ead8?confirm=true" class="option color-3">
                <div class="option-content">
                    <h2>DUTY REPORT</h2>
                </div>
            </a>
            <a href="https://cm.maxient.com/reportingform.php?AUMontgomery&layout_id=4" class="option color-5">
                <div class="option-content">
                    <h2>INCIDENT REPORT</h2>
                </div>
            </a>
            <a href="Weekly Housing Roster for Staff 2024-10-14 08-00-31.csv" class="option color-6" target="_blank">
                <div class="option-content">
                    <h2>DOWNLOAD LATEST STARREZ</h2>
                </div>
            </a>
            <a href="https://aumontgomery-my.sharepoint.com/:x:/g/personal/msmith59_aum_edu/ES5lWxo8CcxBsgu4NelB3JMBv0XhkhI0cjNtxWzj4rHt4Q?e=ZBx4b3" class="option color-1">
                <div class="option-content">
                    <h2>NO ACCESS LIST</h2>
                </div>
            </a>
            <a href="Fall 2024 Duty Calendar.pdf" class="option color-2" target="_blank">
                <div class="option-content">
                    <h2>DUTY SCHEDULE</h2>
                </div>
            </a>
        </div>
    </div>

    <div class="spacer"></div>

    <div class="container emergency-container">
        <h1>Emergency Contacts</h1>
        <p>If there is an emergency, please contact the following:</p>
        <h3><a href="tel:+13343183170" style="color: #A8E600;">CY/WH Duty Phone: +13343183170</a></h3>
        <h3><a href="tel:+13343183171" style="color: #A8E600;">NC/P-40 Duty Phone: +13343183171</a></h3>
        <h3><a href="tel:+13342443424" style="color: #A8E600;">Campus Police: +13342443424</a></h3>
        <br>
        <h1>RLCs</h1>
        <h3><a href="tel:+13343203385" style="color: #A8E600;">Ram: +13343203385</a></h3>
        <h3><a href="tel:+1332355208" style="color: #A8E600;">Amberly: +1332355208</a></h3>
        <h3><a href="tel:+1332243791" style="color: #A8E600;">Lauryn: +1332243791</a></h3>
        <h3><a href="tel:+13343003269" style="color: #A8E600;">Taylor: +13343003269</a></h3>
    </div>

    <div id="dutyDayContainer" class="duty-day-container"></div>

    <script>
        const notificationBell = document.getElementById('notificationBell');
        const notificationDropdown = document.getElementById('notificationDropdown');
        const notificationList = document.getElementById('notificationList');
        const notificationDot = document.getElementById('notificationDot');

        notificationBell.addEventListener('click', () => {
            notificationDropdown.classList.toggle('show');
            loadNotifications();
            notificationDot.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (!event.target.matches('.notification-bell')) {
                if (notificationDropdown.classList.contains('show')) {
                    notificationDropdown.classList.remove('show');
                }
            }
        });

        async function fetchNotifications() {
            const apiKey = 'patHsrrNu8CMXvlpA.debf08c28e5905ff5a415cdacb999abd2695b1559cb5f9feb22c84fb1310e428'; // Replace with your Airtable Personal Access Token
            const baseId = 'appoXg3vvpfVAXmqH'; // Replace with your Airtable Base ID
            const tableName = 'notifications'; // Notifications - Name of your table
            const url = `https://api.airtable.com/v0/${baseId}/${tableName}`;

            const response = await fetch(url, {
                headers: {
                    Authorization: `Bearer ${apiKey}`
                }
            });

            if (!response.ok) {
                console.error('Error fetching data:', response.statusText);
                return [];
            }

            const data = await response.json();
            return data.records;
        }

        function filterNotifications(records) {
            const currentTime = new Date();
            return records.filter(record => {
                const dateToPost = new Date(record.fields.date_to_post);
                const dateToRemove = new Date(record.fields.date_to_remove);
                return (currentTime >= dateToPost && currentTime < dateToRemove);
            });
        }

        async function loadNotifications() {
            const records = await fetchNotifications();
            const notifications = filterNotifications(records);

            notificationList.innerHTML = '';
            if (notifications.length === 0) {
                notificationList.innerHTML = '<li>No new notifications</li>';
                notificationDot.style.display = 'none';
            } else {
                notificationDot.style.display = 'block';
                notifications.forEach(notification => {
                    const li = document.createElement('li');
                    li.textContent = `Subject: "${notification.fields.subject}" - Message: "${notification.fields.message}"`;
                    notificationList.appendChild(li);
                });
            }
        }

        function loadDutyDayData() {
            const dutyDayContainer = document.getElementById("dutyDayContainer");
            const currentDate = new Date();
            const currentDay = currentDate.getDay();
            const currentHour = currentDate.getHours();

            fetchDutyDayDataFromAirtable().then(dutyData => {
                if ((currentDay >= 1 && currentDay <= 5 && currentHour >= 17) ||
                    ((currentDay === 0 && currentHour >= 8) || 
                     (currentDay === 6 && currentHour >= 8) || 
                     (currentDay === 0 && currentHour < 8))) {

                    dutyDayContainer.innerHTML = `
                        <h1>Duty Day</h1><br>
                        <p>Warhawk/Courtyards:</p> <br><p><h3><strong>${dutyData['warhawk/courtyards']}</strong></h3></p><br>
                        <p>Commons/P-40:</p> <br><p><h3><strong>${dutyData['commons/p-40']}</strong></h3></p><br>
                        <p>RLC:</p> <br><p><h3><strong>${dutyData['rlc']}</strong></h3></p>
                    `;
                } else if (currentDay >= 1 && currentDay <= 5 && currentHour < 8) {
                    dutyDayContainer.innerHTML = `
                        <h1>Duty Day</h1>
                        <p>Will update at 5:00 PM.</p>
                    `;
                }
            });
        }

        async function fetchDutyDayDataFromAirtable() {
            const apiKey = 'patgvs2yNFvsy0nld.0cda1f2d1a51d3457f35d49b75ee6a8e05a9539a19583b80dc5e2c2c8ed121db'; // Replace with your Airtable Personal Access Token
            const baseId = 'appoXg3vvpfVAXmqH'; // Replace with your Airtable Base ID
            const tableName = 'dutyday'; // DutyDay - Name of your table
            const url = `https://api.airtable.com/v0/${baseId}/${tableName}`;

            const response = await fetch(url, {
                headers: {
                    Authorization: `Bearer ${apiKey}`
                }
            });

            const data = await response.json();
            return data.records[0].fields; 
        }

        loadDutyDayData();
        loadNotifications();
    </script>
</body>
</html>
